// Inside the primary Process recursive worker method:

// 1. First, process all FILES in the array:
foreach ( var file in files )
{
    // Use FileAttributes to reliably check if it's a directory (or a file)
    if ( ( file.Attributes & FileAttributes.Directory ) != 0 )
    {
        // Skip directories for now; we only process files here.
        continue;
    }

    // -- Start FILE PROCESSING logic --
    
    // Apply input regex filters
    if ( InputRegex.Count > 0 )
    {
        // ... (existing regex filtering logic) ...
    }
    
    // Apply filename filter delegate
    if ( ( InputFilter != null )
         && !InputFilter( file.Directory!.FullName, file.Name ) )
    {
        continue;
    }
    
    // Determine output file name and create entry (existing logic)
    var outputName = file.Name;
    // ... (output name/suffix logic) ...

    var entry = new Entry
    {
        // ... (entry creation logic) ...
    };

    var dir = file.Directory!;

    // Add entry to the directory's entry list
    if ( !dirToEntries.TryGetValue( dir, out var dirList ) )
    {
        dirList             = [ ];
        dirToEntries[ dir ] = dirList;
    }

    dirList?.Add( entry );
    
    // -- End FILE PROCESSING logic --
}


// 2. Next, handle RECURSIVE DIRECTORY TRAVERSAL:
if ( Recursive )
{
    // We need to iterate over the contents of the starting directory,
    // getting only the subdirectories.

    // Get the directory containing these files (assuming a non-flat structure)
    var inputDir = files.FirstOrDefault(f => f.Directory != null)?.Directory;

    if ( inputDir != null )
    {
        var subdirectories = inputDir.GetDirectories();

        foreach ( var subdirInfo in subdirectories )
        {
            var subdirOutput = outputDir.FullName.Length == 0
                ? new DirectoryInfo( subdirInfo.Name )
                : new DirectoryInfo( Path.Combine( outputDir.FullName, subdirInfo.Name ) );
            
            // Recursively process the subdirectory's files
            Process( subdirInfo.GetFiles(), 
                     outputRoot, 
                     subdirOutput, 
                     dirToEntries, 
                     depth + 1 );
        }
    }
}